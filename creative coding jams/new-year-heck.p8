pico-8 cartridge // http://www.pico-8.com
version 29
__lua__

player_x = 56
player_y = 120
player_spd = 1

ball_health = 128

ball_x = 56
ball_dir = 1
ball_spd = 0.5
ball_move_lim = 40
ball_y_anchor = 40
ball_y = ball_y_anchor
ball_sway = 25
ball_sway_speed = 0.3
ball_sprites = {1, 3, 5, 7}
ball_anim_speed = 5
ball_frame = 0

bull_x_vel = 1
bull_y_vel = 0.5
bull_grav = 0.02

fwks_x_vel = 3
fwks_y_vel = 0.2
fwks_freq = 1
fwks_life = 1
fwks_grav = 0.01
fwks_x_drag = 0.95

expl_frames = {9, 11, 13, 41}
expl_life = 0.5

player_died = false
p_bullet_spd = 1
p_bullets = {}
p_bullets_cooldown = 0
p_bullets_cooldown_len = 10

function _update60()

 if btn(0) then
  player_x -= player_spd
 end
 if btn(1) then
  player_x += player_spd
 end

 if(p_bullets_cooldown > 0) p_bullets_cooldown -= 1

 if btn(2) then
  if p_bullets_cooldown == 0 then
   add(p_bullets, {x = player_x + 4, y = player_y})
   p_bullets_cooldown += p_bullets_cooldown_len
  end
 end
  
 for pb in all(p_bullets) do
  pb.y -= p_bullet_spd
  if mid(pb.x, ball_x, ball_x + 16) == pb.x and mid(pb.y, ball_y, ball_y + 16) == pb.y then
   ball_health -= 1
   del(p_bullets, pb)
   if pb.y < 0 then
    del(p_bullets, pb)
   end
  end
 end


 ball_y = ball_y_anchor + sin(time() * ball_sway_speed) * ball_sway
 if abs((ball_x + ball_spd * ball_dir) - 56) > ball_move_lim then
  ball_dir *= -1
 end 
 ball_x += ball_spd * ball_dir
 ball_frame = flr((time() * ball_anim_speed) % #ball_sprites) + 1

 if time() % fwks_freq == 0 then
  add_fireworks(ball_x + 8, ball_y + 8)
 end

 for f in all(fireworks) do
  f.x += f.xvel
  f.y += f.yvel
  f.yvel += fwks_grav
  f.xvel *= fwks_x_drag
 end

 for f in all(fireworks) do
  if time() - f.t >= fwks_life then
   for cnt = 1, 8 do
    add(bullets, {
     x = f.x, 
     y = f.y,
     xvel = rnd(bull_x_vel * 2) - bull_x_vel,
     yvel = -.05 - rnd(bull_y_vel * 2) - bull_y_vel,
     c = f.c
    })
   end
   add(explosions, {x = f.x - 8, y = f.y - 8, t = time(), c = f.c})
   del(fireworks, f)
  end
 end

 for e in all(explosions) do 
  if time() - e.t >= expl_life then
   del(explosions, e)
  end
 end

 for b in all(bullets) do 
  if mid(b.x, player_x, player_x + 8) == b.x and mid(b.y, player_y, player_y + 8) == b.y then
   player_died = true   
  end
  b.x += b.xvel
  b.y += b.yvel
  b.yvel += bull_grav
  if b.x < 0 or b.x > 128 or b.y > 128 then
   del(bullets, b)
  end
 end

end

function _draw()
 cls(0)
 if player_died then
  print("dead", 48, 48)
  return
 end

 for f in all(fireworks) do
  pset(f.x, f.y, f.c)
 end

 for e in all(explosions) do
  local frame = flr(((time() - e.t) / expl_life) * #expl_frames) + 1
  pal(8, e.c, 0)
  spr(expl_frames[frame], e.x, e.y, 2, 2)
  pal()
 end

 for b in all(bullets) do
  pset(b.x, b.y, b.c)
 end

 for pb in all(p_bullets) do
  circfill(pb.x, pb.y, 1, 6)
 end

 spr(ball_sprites[ball_frame], ball_x, ball_y, 2, 2)
 spr(43, player_x, player_y)
 rectfill(0, 0, ball_health, 4, 8)

end

fireworks = {}
explosions = {}
bullets = {}

function add_fireworks(x, y)
 add(fireworks, {
  x = x, 
  y = y, 
  xvel = rnd(fwks_x_vel * 2) - fwks_x_vel,
  yvel = -.1 - rnd(fwks_y_vel),
  t = time(),
  c = flr(rnd(15) + 1)
})
end

__gfx__
00000000000006666660000000000666666000000000066666600000000006666660000000000000000000000000000000000000000000000000000000000000
00000000000666666666600000066668666660000006668668666000000666668666600000000000000000000000000000000000000000000000000000000000
00700700006680000008660000660660860866000066668668666600006680680660660000000000000000000000000000000000000008888880000000000000
00077000066806666660866006666066086086600666668668666660066806806606666000000000000000000000000000000000000088888888000000000000
00077000068066666666086006066606606608600666660660660660068066066066606000000000000000000000008888000000000888000088800000000000
00700700660668000086606666686606606660666660660660660666660666066066866600000000000000000000088888800000008880000008880000000000
00000000660660666606606666660660660660666660660660660666660660660660666600000008800000000000888008880000008800088000880000000000
00000000660660666606606666660660660660666660660660660666660660660660666600000088880000000000880000880000008800888800880000000000
00000000660660666606606666660660660660666660660660660666660660660660666600000088880000000000880000880000008800888800880000000000
00000000660660666606606666660660660660666660660660660666660660660660666600000008800000000000888008880000008800088000880000000000
00000000660668000086606666686606606660666660660660660666660666066066866600000000000000000000088888800000008880000008880000000000
00000000068066666666086006066606606608600666660660660660068066066066606000000000000000000000008888000000000888000088800000000000
00000000066806666660866006666066086086600666668668666660066806806606666000000000000000000000000000000000000088888888000000000000
00000000006680000008660000660660860866000066668668666600006680680660660000000000000000000000000000000000000008888880000000000000
00000000000666666666600000066668666660000006668668666000000666668666600000000000000000000000000000000000000000000000000000000000
00000000000006666660000000000666666000000000066666600000000006666660000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000000000000000000000000000000000000000000000000888888000007777777700000000000000000000000000000000
00000000000000000005555550000000000000000000000000000000000000000000000000088000000880007777777700000000000000000000000000000000
00000000000000000005555550000000000000000000000000000000000000000000000000800000000008007777777700000000000000000000000000000000
00000000000000000005555550000000000000000000000000000000000000000000000008000088880000807777777700000000000000000000000000000000
00000000000000000005550005555555000000000000000000000000000000000000000008008888888800807777777700000000000000000000000000000000
00000000000000000005550555555555000000000000000000000000000000000000000080008800008800087777777700000000000000000000000000000000
00000000000000000005550555555555000000000000000000000000000000000000000080088000000880087777777700000000000000000000000000000000
05555555555500000005550555555555000000000000000000000000000000000000000080088008800880087777777700000000000000000000000000000000
05555555555500000005550555555555000000000000000000000000000000000000000080088008800880080000000000000000000000000000000000000000
05555555555500000005550555555555000000000000000000000000000000000000000080088000000880080000000000000000000000000000000000000000
05555555555500000005550555555555000000000000000000000000000000000000000080008800008800080000000000000000000000000000000000000000
05555555500055555505550555555555000000000000000000000000000000000000000008008888888800800000000000000000000000000000000000000000
05555555505555555505550555555555000000000000000000000000000000000000000008000088880000800000000000000000000000000000000000000000
05555555505555555505550555555555000000000000000000000000000000000000000000800000000008000000000000000000000000000000000000000000
05555555505555555505550555555555000000000000000000000000000000000000000000088000000880000000000000000000000000000000000000000000
05555555505555555505550555555555000000000000000000000000000000000000000000000888888000000000000000000000000000000000000000000000
05555555505555555505550555555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555555505555555505550555555000005555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555555505555555505550555555055555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555555505555555505550555555055555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555555505555555505550555555055555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555555505555555505550555555055555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555555505555555505550555555055555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555555505555555505550555555055555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555555505555555505550555555055555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555555505555555505550555555055555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555555505555555505550555555055555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555555505555555505550555555055555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555555505555555505550555555055555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555555505555555505550555555055555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555555505555555505550555555055555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05555555505555555505550555555055555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000055505555555505550555555055555555000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
